FROM maven:3.8.4-openjdk-17 AS builder

WORKDIR /usr/src/app

COPY pom.xml .

RUN mvn dependency:go-offline -B

COPY src ./src

RUN mvn package

FROM arm64v8/maven:3.8.8-eclipse-temurin-17

WORKDIR /usr/src/app

COPY --from=builder /usr/src/app/target/osu-flex-1.0-SNAPSHOT-jar-with-dependencies.jar /usr/src/app/app.jar

ARG MYSQL_DB_URL
ARG MYSQL_DB_USERNAME
ARG MYSQL_DB_PASSWORD
ARG OSU_CLIENT_ID
ARG OSU_CLIENT_SECRET
ARG OSU_API_KEY
ARG DISCORD_TOKEN

ENV MYSQL_DB_URL=$MYSQL_DB_URL
ENV MYSQL_DB_USERNAME=$MYSQL_DB_USERNAME
ENV MYSQL_DB_PASSWORD=$MYSQL_DB_PASSWORD
ENV OSU_CLIENT_ID=$OSU_CLIENT_ID
ENV OSU_CLIENT_SECRET=$OSU_CLIENT_SECRET
ENV OSU_API_KEY=$OSU_API_KEY
ENV DISCORD_TOKEN=$DISCORD_TOKEN

CMD ["java", "-jar", "app.jar"]
